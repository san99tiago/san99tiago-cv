name: deploy

on:
  push:
    branches: ["main", "develop"]

env:
  AWS_DEFAULT_REGION: us-east-1
  AWS_DEFAULT_OUTPUT: json

jobs:
  code-quality:
    name: Check coding standards
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "Job triggered by ${{ github.event_name }} event."
      - run: echo "Job running on a ${{ runner.os }} server hosted by GitHub."
      - run: echo "Branch name is ${{ github.ref }} and repository is ${{ github.repository }}."
      - name: Set up NodeJs
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "src/package-lock.json"
      - name: Run Prettier and Lint
        run: |
          cd src
          npm ci
          npm run prettier-check
          npm run lint

  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up NodeJs
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "src/package-lock.json"
      - name: Install dependencies and run tests
        run: |
          cd src
          npm ci
          npm run test

  build-nextjs:
    name: Build NextJS Application
    runs-on: ubuntu-latest
    needs:
      - code-quality
      - run-tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up NodeJs
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "src/package-lock.json"
      - name: Build NextJs App to Output folder
        run: bash build.sh
      - name: Archive NextJS Output dir
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-output-dir
          path: src/out

  cdk-synth-diff:
    name: CDK Synth & Diff
    runs-on: ubuntu-latest
    needs: build-nextjs
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    outputs:
      deployment-environment: ${{ steps.setup-env.outputs.deployment-environment }}
      stacks-status: ${{ steps.synth-stacks.outputs.stacks-status }}
    steps:
      - uses: actions/checkout@v4

      - name: Download NextJS output folder
        uses: actions/download-artifact@v4
        with:
          name: nextjs-output-dir
          path: ./src/out

      - name: Set up NodeJs
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "cdk/package-lock.json"

      - name: Install CDK and Modules
        run: |
          npm install -g aws-cdk
          cd ./cdk
          npm ci

      # Same task with different secrets depending on the branch ref (dev vs prod deployments)
      # Note: there might be better alternatives, but this is a workaround to deploy to both envs
      - name: Configure AWS Credentials (DEV)
        if: github.ref != 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.DEV_AWS_ACCOUNT_ID }}:role/${{ secrets.DEV_AWS_DEPLOY_ROLE }}
          role-session-name: myGitHubActions
      - name: Configure AWS Credentials (PROD)
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.PROD_AWS_ACCOUNT_ID }}:role/${{ secrets.PROD_AWS_DEPLOY_ROLE }}
          role-session-name: myGitHubActions

      - run: aws sts get-caller-identity

      # Not 100% optimal, but does the work for setting deployment environments from branch
      - name: Setup Deployment Environment from Branch
        id: setup-env
        run: |
          # To update the deployment environment based on the git branch
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "DEPLOYMENT_ENVIRONMENT=prod" >> "$GITHUB_ENV"
            echo "deployment-environment=prod" >> "$GITHUB_OUTPUT"
            echo "Deployment environment is PROD"
          else
            echo "DEPLOYMENT_ENVIRONMENT=dev" >> "$GITHUB_ENV"
            echo "deployment-environment=dev" >> "$GITHUB_OUTPUT"
            echo "Deployment environment is DEV"
          fi

      - name: CDK List Stacks
        id: list-stacks
        run: |
          cd ./cdk
          echo "Available stacks:"
          export CI=true
          cdk list
          STACK_IDS=$(CI=true cdk list | sed 's/ (.*//' | tr '\n' ' ')
          echo "stack-list=$STACK_IDS" >> "$GITHUB_OUTPUT"

      - name: CDK Synth All Stacks
        id: synth-stacks
        run: |
          cd ./cdk
          echo "Synthesizing all stacks..."
          export CI=true

          SYNTH_SUCCESS=true
          FAILED_STACKS=""
          SUCCESS_STACKS=""

          STACKS=$(CI=true cdk list | sed 's/ (.*//')
          STACKS_COMMA=$(echo "$STACKS" | tr '\n' ',' | sed 's/,$//')

          if CI=true cdk synth; then
            echo "âœ… All stacks synthesized successfully"
            SUCCESS_STACKS="$STACKS_COMMA"
          else
            echo "âŒ CDK synth failed for some stacks"
            SYNTH_SUCCESS=false
            FAILED_STACKS="$STACKS_COMMA"
          fi

          echo "synth-success=$SYNTH_SUCCESS" >> "$GITHUB_OUTPUT"
          echo "failed-stacks=$FAILED_STACKS" >> "$GITHUB_OUTPUT"
          echo "success-stacks=$SUCCESS_STACKS" >> "$GITHUB_OUTPUT"

          if [ "$SYNTH_SUCCESS" = "true" ]; then
            echo "stacks-status=success" >> "$GITHUB_OUTPUT"
          else
            echo "stacks-status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: CDK Diff All Stacks
        if: steps.synth-stacks.outputs.synth-success == 'true'
        run: |
          cd ./cdk
          echo "Running diff for all stacks..."
          export CI=true

          STACKS_RAW=$(CI=true cdk list | sed 's/ (.*//')
          STACKS=$(echo "$STACKS_RAW" | tr '\n' ' ')

          echo "ðŸ“‹ Showing differences for all stacks:"
          for stack in $STACKS; do
            echo ""
            echo "ðŸ” Diff for stack: $stack"
            echo "----------------------------------------"
            if CI=true cdk diff "$stack"; then
              echo "âœ… Diff completed for $stack"
            else
              echo "âš ï¸  Diff failed for $stack (this might be normal for new stacks)"
            fi
            echo "----------------------------------------"
          done

      - name: Report Synth Results
        if: always()
        run: |
          echo "## CDK Synth & Diff Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.synth-stacks.outputs.synth-success }}" = "true" ]; then
            echo "âœ… **Status**: All stacks synthesized successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Successful Stacks**: ${{ steps.synth-stacks.outputs.success-stacks }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Synth failed for some stacks" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¥ **Failed Stacks**: ${{ steps.synth-stacks.outputs.failed-stacks }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Environment**: ${{ steps.setup-env.outputs.deployment-environment }}" >> $GITHUB_STEP_SUMMARY

      - name: Archive CDK Synth results (no assets)
        uses: actions/upload-artifact@v4
        with:
          name: cdk-synth-folder
          path: |
            ./cdk/cdk.out
            !./cdk/cdk.out/asset.*
          retention-days: 1

  iac-checkov:
    name: IaC Checkov Validations
    runs-on: ubuntu-latest
    needs: cdk-synth-diff
    steps:
      - uses: actions/checkout@v4

      - name: Download CDK Synth results
        uses: actions/download-artifact@v4
        with:
          name: cdk-synth-folder
          path: ./cdk-synth-output-folder

      - name: Display files in the output folder
        run: tree
        working-directory: ./cdk-synth-output-folder

      - name: Run Checkov action
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: cdk-synth-output-folder/
          framework: cloudformation
          soft_fail: true # optional: do not return an error code if there are failed checks
          skip_check: CKV_AWS_2 # optional: skip a specific check_id. can be comma separated list
          quiet: true # optional: display only failed checks

  cdk-deploy:
    name: Deploy CDK
    runs-on: ubuntu-latest
    needs:
      - iac-checkov
      - cdk-synth-diff
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    outputs:
      deployment-status: ${{ steps.deploy-stacks.outputs.deployment-status }}
      successful-stacks: ${{ steps.deploy-stacks.outputs.successful-stacks }}
      failed-stacks: ${{ steps.deploy-stacks.outputs.failed-stacks }}
    steps:
      - uses: actions/checkout@v4

      - name: Download NextJS output folder
        uses: actions/download-artifact@v4
        with:
          name: nextjs-output-dir
          path: ./src/out

      - name: Set up NodeJs
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "cdk/package-lock.json"

      - name: Install CDK and Modules
        run: |
          npm install -g aws-cdk
          cd ./cdk
          npm ci

      # Same task with different secrets depending on the branch ref (dev vs prod deployments)
      # Note: there might be better alternatives, but this is a workaround to deploy to both envs
      - name: Configure AWS Credentials (DEV)
        if: github.ref != 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.DEV_AWS_ACCOUNT_ID }}:role/${{ secrets.DEV_AWS_DEPLOY_ROLE }}
          role-session-name: myGitHubActions
      - name: Configure AWS Credentials (PROD)
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.PROD_AWS_ACCOUNT_ID }}:role/${{ secrets.PROD_AWS_DEPLOY_ROLE }}
          role-session-name: myGitHubActions

      # Not 100% optimal, but does the work for setting deployment environments from branch
      - name: Setup Deployment Environment from Branch
        run: |
          # To update the deployment environment based on the git branch
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "DEPLOYMENT_ENVIRONMENT=prod" >> "$GITHUB_ENV"
            echo "Deployment environment is PROD"
          else
            echo "DEPLOYMENT_ENVIRONMENT=dev" >> "$GITHUB_ENV"
            echo "Deployment environment is DEV"
          fi

      - name: Deploy All Stacks to AWS
        id: deploy-stacks
        run: |
          cd ./cdk
          echo "ðŸš€ Starting deployment of all enabled stacks..."
          echo "Environment: $DEPLOYMENT_ENVIRONMENT"

          export CI=true

          OVERALL_SUCCESS=true
          SUCCESSFUL_STACKS=""
          FAILED_STACKS=""
          DEPLOYMENT_SUMMARY=""

          STACKS_RAW=$(CI=true cdk list | sed 's/ (.*//')
          STACKS=$(echo "$STACKS_RAW" | tr '\n' ' ')
          TOTAL_STACKS=$(echo "$STACKS_RAW" | wc -l)

          echo "ðŸ“‹ Found $TOTAL_STACKS stack(s) to deploy:"
          for stack in $STACKS; do
            echo "  - $stack"
          done
          echo ""

          STACK_COUNT=0
          for stack in $STACKS; do
            STACK_COUNT=$((STACK_COUNT + 1))
            echo "ðŸ”„ Deploying stack $STACK_COUNT/$TOTAL_STACKS: $stack"
            echo "----------------------------------------"
            
            if CI=true cdk deploy "$stack" --require-approval never; then
              echo "âœ… Successfully deployed: $stack"
              if [ -z "$SUCCESSFUL_STACKS" ]; then
                SUCCESSFUL_STACKS="$stack"
              else
                SUCCESSFUL_STACKS="$SUCCESSFUL_STACKS,$stack"
              fi
              DEPLOYMENT_SUMMARY="$DEPLOYMENT_SUMMARY\nâœ… $stack: SUCCESS"
            else
              echo "âŒ Failed to deploy: $stack"
              OVERALL_SUCCESS=false
              if [ -z "$FAILED_STACKS" ]; then
                FAILED_STACKS="$stack"
              else
                FAILED_STACKS="$FAILED_STACKS,$stack"
              fi
              DEPLOYMENT_SUMMARY="$DEPLOYMENT_SUMMARY\nâŒ $stack: FAILED"
              echo "âš ï¸  Continuing with remaining stacks..."
            fi
            echo "----------------------------------------"
            echo ""
          done

          echo "ðŸ“Š DEPLOYMENT SUMMARY"
          echo "===================="
          echo -e "$DEPLOYMENT_SUMMARY"
          echo ""

          if [ "$OVERALL_SUCCESS" = "true" ]; then
            echo "ðŸŽ‰ All stacks deployed successfully!"
            echo "deployment-status=success" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸  Some stacks failed to deploy"
            echo "deployment-status=partial" >> "$GITHUB_OUTPUT"
          fi

          echo "successful-stacks=$SUCCESSFUL_STACKS" >> "$GITHUB_OUTPUT"
          echo "failed-stacks=$FAILED_STACKS" >> "$GITHUB_OUTPUT"

          if [ "$OVERALL_SUCCESS" = "false" ]; then
            echo "âŒ Deployment completed with failures"
            exit 1
          fi

      - name: Report Deployment Results
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "${{ steps.deploy-stacks.outputs.deployment-status }}" in
            "success")
              echo "âœ… **Status**: All stacks deployed successfully" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŽ¯ **Successful Stacks**: ${{ steps.deploy-stacks.outputs.successful-stacks }}" >> $GITHUB_STEP_SUMMARY
              ;;
            "partial")
              echo "âš ï¸ **Status**: Partial deployment (some stacks failed)" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Successful Stacks**: ${{ steps.deploy-stacks.outputs.successful-stacks }}" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **Failed Stacks**: ${{ steps.deploy-stacks.outputs.failed-stacks }}" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "âŒ **Status**: Deployment failed" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¥ **Failed Stacks**: ${{ steps.deploy-stacks.outputs.failed-stacks }}" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Environment**: ${{ needs.cdk-synth-diff.outputs.deployment-environment }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Deployed at**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  deployment-notification:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs:
      - cdk-deploy
      - cdk-synth-diff
    if: always()
    steps:
      - name: Notify Deployment Status
        run: |
          echo "## ðŸ“¢ Final Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.cdk-deploy.result }}" = "success" ]; then
            echo "ðŸŽ‰ **Overall Status**: SUCCESS - All stacks deployed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Successful Stacks**: ${{ needs.cdk-deploy.outputs.successful-stacks }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.cdk-deploy.result }}" = "failure" ]; then
            if [ -n "${{ needs.cdk-deploy.outputs.successful-stacks }}" ]; then
              echo "âš ï¸ **Overall Status**: PARTIAL SUCCESS - Some stacks deployed, others failed" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Successful Stacks**: ${{ needs.cdk-deploy.outputs.successful-stacks }}" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **Failed Stacks**: ${{ needs.cdk-deploy.outputs.failed-stacks }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Overall Status**: FAILURE - No stacks were deployed successfully" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¥ **Failed Stacks**: ${{ needs.cdk-deploy.outputs.failed-stacks }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Overall Status**: SKIPPED - Deployment was skipped or cancelled" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Environment**: ${{ needs.cdk-synth-diff.outputs.deployment-environment }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
